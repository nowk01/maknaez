<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.maknaez.mapper.ProductMapper">

    <sql id="where-list">
        <where>
            p.is_displayed = 1

            <!-- 1. 대분류 필터 (MEN, WOMEN, SPORTSTYLE) -->
            <if test="category != null and category != '' and category != 'sale' and category != 'sportstyle'">
                AND (UPPER(c.cate_parent) = UPPER(#{category}) OR UPPER(c.cate_code) = UPPER(#{category}))
            </if>
            
            <if test="category == 'sportstyle'">
                AND UPPER(c.cate_parent) = 'SPORTSTYLE'
            </if>

            <if test="category == 'sale'">
                AND (SELECT val FROM DISCOUNTS WHERE target_id = p.prod_id AND SYSDATE BETWEEN start_date AND end_date AND is_active = 1) > 0
            </if>

            <!-- 3. 중분류 필터 (단일값) -->
            <if test="subCategory != null and subCategory != ''">
                AND p.cate_code LIKE '%' || UPPER(#{subCategory}) || '%'
            </if>

            <!-- [복구] 3-1. 중분류 체크박스 (sports 배열) -->
            <if test="sports != null and sports.length > 0">
                AND c.cate_name IN 
                <foreach collection="sports" item="sport" open="(" close=")" separator=",">
                    #{sport}
                </foreach>
            </if>

            <!-- [복구] 3-2. 성별 체크박스 (genders 배열) -->
            <if test="genders != null and genders.length > 0">
                AND c.cate_parent IN (
                    SELECT sub.cate_code FROM CATEGORY sub 
                    WHERE sub.cate_name IN 
                    <foreach collection="genders" item="gender" open="(" close=")" separator=",">
                        #{gender}
                    </foreach>
                )
            </if>

            <!-- [복구] 3-3. 색상 체크박스 (colors 배열) -->
            <if test="colors != null and colors.length > 0">
                AND (
                    <foreach collection="colors" item="color" separator=" OR ">
                        p.prod_name LIKE '%' || #{color} || '%'
                    </foreach>
                )
            </if>

            <!-- 4. 특수 필터 -->
            <if test="filter == 'new'">
                AND p.prod_date >= SYSDATE - 30
            </if>
            <if test="filter == 'goretex'">
                AND (UPPER(p.prod_name) LIKE '%GTX%' OR UPPER(p.prod_name) LIKE '%GORE-TEX%')
            </if>
            <if test="filter == 'slab'">
                AND UPPER(p.prod_name) LIKE '%S/LAB%'
            </if>

            <!-- 5. 가격대 필터 -->
            <if test="minPrice != null and minPrice != ''">
                AND p.base_price >= TO_NUMBER(#{minPrice})
            </if>
            <if test="maxPrice != null and maxPrice != ''">
                AND p.base_price &lt;= TO_NUMBER(#{maxPrice})
            </if>
            
            <!-- 6. 할인율 필터 -->
            <if test="discountRate == 'under10'"> 
                AND (SELECT val FROM DISCOUNTS WHERE target_id = p.prod_id AND SYSDATE BETWEEN start_date AND end_date AND is_active=1) &lt; 10 
            </if>
            <if test="discountRate == 'under20'"> 
                AND (SELECT val FROM DISCOUNTS WHERE target_id = p.prod_id AND SYSDATE BETWEEN start_date AND end_date AND is_active=1) &lt; 20 
            </if>
            
            <!-- 7. 품절 제외 (재고 컬럼 확인 후 주석 해제) -->
            <!-- 
            <if test="excludeSoldOut != null">
                AND p.stock > 0 
            </if> 
            -->
        </where>
    </sql>

    <!-- 리스트 조회 -->
    <select id="listProduct" parameterType="map" resultType="com.maknaez.model.ProductDTO">
        SELECT 
            p.prod_id       AS prodId,
            p.prod_name     AS prodName,
            p.base_price    AS price,
            p.thumb_nail    AS thumbnail,
            p.prod_desc     AS description,
            TO_CHAR(p.prod_date, 'YYYY-MM-DD') AS regDate,
            
            p.cate_code     AS cateCode,
            c.cate_name     AS cateName,
            c.cate_parent   AS cateParent,
            
            NVL((SELECT val FROM DISCOUNTS WHERE target_id = p.prod_id AND SYSDATE BETWEEN start_date AND end_date AND is_active = 1), 0) AS discountRate,
            p.base_price    AS originalPrice
            
        FROM PRODUCTS p
        LEFT JOIN CATEGORY c ON p.cate_code = c.cate_code
        
        <include refid="where-list"/>
        
        <choose>
            <when test="sort == 'price_asc'">ORDER BY p.base_price ASC</when>
            <when test="sort == 'price_desc'">ORDER BY p.base_price DESC</when>
            <otherwise>ORDER BY p.prod_date DESC</otherwise>
        </choose>
        
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>

    <!-- 개수 조회 -->
    <select id="dataCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM PRODUCTS p
        LEFT JOIN CATEGORY c ON p.cate_code = c.cate_code
        <include refid="where-list"/>
    </select>
	
	<!-- 카테고리 관련 쿼리 -->
	<select id="listCategory" resultType="com.maknaez.model.CategoryDTO">
	    SELECT 
	        CATE_CODE   AS cateCode,
	        CATE_NAME   AS cateName,
	        CATE_PARENT AS cateParent,
	        DEPTH       AS depth,
	        STATUS      AS status,
	        ORDER_NO    AS orderNo
	    FROM EZ.CATEGORY
	    ORDER BY COALESCE(CATE_PARENT, CATE_CODE) ASC, ORDER_NO ASC
	</select>
	
	<insert id="insertCategory" parameterType="com.maknaez.model.CategoryDTO">
	    INSERT INTO EZ.CATEGORY (CATE_CODE, CATE_NAME, CATE_PARENT, DEPTH, STATUS, ORDER_NO)
	    VALUES (
	        TO_CHAR(SEQ_CATEGORY.NEXTVAL), 
	        #{cateName}, 
	        #{cateParent, jdbcType=VARCHAR}, 
	        #{depth}, 
	        #{status}, 
	        #{orderNo}
	    )
	</insert>
	
	<update id="updateCategory" parameterType="com.maknaez.model.CategoryDTO">
	    UPDATE EZ.CATEGORY 
	    SET CATE_NAME = #{cateName}, 
	        STATUS = #{status}, 
	        ORDER_NO = #{orderNo}
	    WHERE CATE_CODE = #{cateCode}
	</update>
	
	<delete id="deleteCategory" parameterType="string">
	    DELETE FROM EZ.CATEGORY WHERE CATE_CODE = #{cateCode}
	</delete>
</mapper>