<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.maknaez.mapper.ProductMapper">

     <sql id="where-list">
        <where>
            p.is_displayed = 1
            AND c.status = 1

            <!-- 1. 대분류 필터 (MEN, WOMEN) -->
            <!-- MEN: 남성(M) + 유니섹스(U) -->
            <if test="category == 'men'">
                AND (p.prod_name LIKE 'M\_%' ESCAPE '\' OR p.prod_name LIKE 'U\_%' ESCAPE '\')
            </if>
            
            <!-- WOMEN: 여성(F) + 유니섹스(U) -->
            <if test="category == 'women'">
                AND (p.prod_name LIKE 'F\_%' ESCAPE '\' OR p.prod_name LIKE 'U\_%' ESCAPE '\')
            </if>
            
            <!-- SPORTSTYLE: 카테고리 계층 구조 사용 (또는 U_ 로만 검색해도 됨) -->
            <if test="category == 'sportstyle'">
                AND UPPER(c.cate_parent) = 'SPORTSTYLE'
            </if>

            <!-- 2. SALE 대분류: 할인값이 0보다 큰 경우 -->
            <if test="category == 'sale'">
                AND (SELECT val 
                     FROM DISCOUNTS 
                     WHERE target_id = p.prod_id 
                     AND SYSDATE BETWEEN start_date AND end_date
                     AND is_active = 1) > 0
            </if>

            <!-- 3. 중분류 필터 (상단 메뉴 링크용) -->
            <if test="subCategory != null and subCategory != ''">
                AND p.cate_code LIKE '%' || UPPER(#{subCategory}) || '%'
            </if>

            <!-- 3-1. 사이드바 - 카테고리(중분류) 체크박스 -->
            <if test="sports != null and sports.length > 0">
                AND c.cate_name IN 
                <foreach collection="sports" item="sport" open="(" close=")" separator=",">
                    #{sport}
                </foreach>
            </if>

            <!-- 3-2. 사이드바 - 성별 체크박스 (이름 기반 필터링) -->
            <if test="genders != null and genders.length > 0">
                AND (
                    <foreach collection="genders" item="gender" separator=" OR ">
                        <!-- M, F, U 값에 따라 이름 앞글자 매칭 -->
                        p.prod_name LIKE #{gender} || '\_%' ESCAPE '\'
                    </foreach>
                )
            </if>

            <!-- 3-3. 사이드바 - 색상 체크박스 (이름 기반 필터링) -->
            <if test="colors != null and colors.length > 0">
                AND (
                    <foreach collection="colors" item="color" separator=" OR ">
                        <!-- _BK, _WH 등 접미사 매칭 -->
                        p.prod_name LIKE '%\_' || #{color} ESCAPE '\'
                    </foreach>
                )
            </if>

            <!-- 4. 특수 필터 -->
            <if test="filter == 'new'">
                AND p.prod_date >= SYSDATE - 30
            </if>
            <if test="filter == 'goretex'">
                AND (UPPER(p.prod_name) LIKE '%GTX%' OR UPPER(p.prod_name) LIKE '%GORE-TEX%')
            </if>
            <if test="filter == 'slab'">
                AND UPPER(p.prod_name) LIKE '%S/LAB%'
            </if>

            <!-- 5. 가격대 필터 (슬라이더) -->
            <if test="minPrice != null and minPrice != ''">
                AND p.base_price >= TO_NUMBER(#{minPrice})
            </if>
            <if test="maxPrice != null and maxPrice != ''">
                AND p.base_price &lt;= TO_NUMBER(#{maxPrice})
            </if>
            
            <!-- 6. 할인율 필터 -->
            <if test="discountRate == 'under10'"> 
                AND (SELECT val FROM DISCOUNTS WHERE target_id = p.prod_id AND SYSDATE BETWEEN start_date AND end_date AND is_active=1) &lt; 10 
            </if>
            <if test="discountRate == 'under20'"> 
                AND (SELECT val FROM DISCOUNTS WHERE target_id = p.prod_id AND SYSDATE BETWEEN start_date AND end_date AND is_active=1) &lt; 20 
            </if>
        </where>
    </sql>

    <!-- 상품 목록 조회 -->
    <select id="listProduct" parameterType="map" resultType="com.maknaez.model.ProductDTO">
        SELECT 
            p.prod_id       AS prodId,
            p.prod_name     AS prodName,
            p.base_price    AS price,
            p.thumb_nail    AS thumbnail,
            p.prod_desc     AS description,
            TO_CHAR(p.prod_date, 'YYYY-MM-DD') AS regDate,
            
            p.cate_code     AS cateCode,
            c.cate_name     AS cateName,
            c.cate_parent   AS cateParent,
            
            <!-- 할인율 조회 -->
            NVL((SELECT val 
                 FROM DISCOUNTS 
                 WHERE target_id = p.prod_id 
                 AND SYSDATE BETWEEN start_date AND end_date
                 AND is_active = 1), 0) AS discountRate,
                 
            p.base_price    AS originalPrice
            
        FROM PRODUCTS p
        LEFT JOIN CATEGORY c ON p.cate_code = c.cate_code
        
        <include refid="where-list"/>
        
        <choose>
            <when test="sort == 'price_asc'">ORDER BY p.base_price ASC</when>
            <when test="sort == 'price_desc'">ORDER BY p.base_price DESC</when>
            <otherwise>ORDER BY p.prod_date DESC</otherwise>
        </choose>
        
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>

    <!-- 개수 조회 -->
    <select id="dataCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM PRODUCTS p
        LEFT JOIN CATEGORY c ON p.cate_code = c.cate_code
        <include refid="where-list"/>
    </select>
    
    <!-- 사이드바 카테고리명 목록 조회 -->
    <select id="listCategoryNames" parameterType="String" resultType="String">
        SELECT cate_name
        FROM CATEGORY
        WHERE status = 1 
          AND cate_parent = UPPER(#{categoryCode})
        ORDER BY order_no ASC
    </select>
    
    <!-- 세일카테고리 -->
    <select id="listSaleCategoryNames" resultType="String">
        SELECT DISTINCT c.cate_name
        FROM PRODUCTS p
        JOIN CATEGORY c ON p.cate_code = c.cate_code
        WHERE (SELECT val 
               FROM DISCOUNTS 
               WHERE target_id = p.prod_id 
               AND SYSDATE BETWEEN start_date AND end_date
               AND is_active = 1) > 0
        ORDER BY c.cate_name
    </select>
    
	
	<!-- 카테고리 관리(관리자용) -->
	<select id="listCategory" resultType="com.maknaez.model.CategoryDTO">
	    SELECT 
	        CATE_CODE   AS cateCode,
	        CATE_NAME   AS cateName,
	        CATE_PARENT AS cateParent,
	        DEPTH       AS depth,
	        STATUS      AS status,
	        ORDER_NO    AS orderNo
	    FROM EZ.CATEGORY
	    ORDER BY COALESCE(CATE_PARENT, CATE_CODE) ASC, ORDER_NO ASC
	</select>
	
	<insert id="insertCategory" parameterType="com.maknaez.model.CategoryDTO">
	    INSERT INTO EZ.CATEGORY (CATE_CODE, CATE_NAME, CATE_PARENT, DEPTH, STATUS, ORDER_NO)
	    VALUES (
	        #{cateCode}, 
	        #{cateName}, 
	        #{cateParent, jdbcType=VARCHAR}, 
	        #{depth}, 
	        #{status}, 
	        #{orderNo}
	    )
	</insert>
	
	<update id="updateCategory" parameterType="com.maknaez.model.CategoryDTO">
		 UPDATE EZ.CATEGORY SET
		     CATE_CODE = #{cateCode}, CATE_NAME = #{cateName}, STATUS = #{status}, ORDER_NO = #{orderNo}
		 WHERE CATE_CODE = #{originCateCode, jdbcType=VARCHAR} 
    </update>
	
	<delete id="deleteCategory" parameterType="string">
	    DELETE FROM EZ.CATEGORY WHERE CATE_CODE = #{cateCode}
	</delete>
</mapper>