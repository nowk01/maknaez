<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.maknaez.mapper.ProductMapper">

    <!-- 검색 조건 -->
    <sql id="where-list">
        <where>
            p.is_displayed = 1

            <!-- 1. 대분류 필터 (MEN, WOMEN) -->
            <if test="category != null and category != '' and category != 'sale' and category != 'sportstyle'">
                AND (UPPER(c.cate_parent) = UPPER(#{category}) OR UPPER(c.cate_code) = UPPER(#{category}))
            </if>
            
            <!-- SPORTSTYLE 필터 -->
            <if test="category == 'sportstyle'">
                AND UPPER(c.cate_parent) = 'SPORTSTYLE'
            </if>

            <!-- 2. SALE 대분류: 할인값이 0보다 큰 경우 (target_id 사용) -->
            <if test="category == 'sale'">
                AND (SELECT val 
                     FROM DISCOUNTS 
                     WHERE target_id = p.prod_id 
                     AND SYSDATE BETWEEN start_date AND end_date
                     AND is_active = 1) > 0
            </if>

            <!-- 3. 중분류 필터 -->
            <if test="subCategory != null and subCategory != ''">
                AND p.cate_code LIKE '%' || UPPER(#{subCategory}) || '%'
            </if>

            <!-- 4. 특수 필터 -->
            <if test="filter == 'new'">
                AND p.prod_date >= SYSDATE - 30
            </if>
            <if test="filter == 'goretex'">
                AND (UPPER(p.prod_name) LIKE '%GTX%' OR UPPER(p.prod_name) LIKE '%GORE-TEX%')
            </if>
            <if test="filter == 'slab'">
                AND UPPER(p.prod_name) LIKE '%S/LAB%'
            </if>

            <!-- 5. 가격대 필터 -->
            <if test="minPrice != null and minPrice != ''">
                AND p.base_price >= TO_NUMBER(#{minPrice})
            </if>
            <if test="maxPrice != null and maxPrice != ''">
                AND p.base_price &lt;= TO_NUMBER(#{maxPrice})
            </if>
            
            <!-- 6. 할인율 필터 (val 컬럼 사용) -->
            <if test="discountRate == 'under10'"> 
                AND (SELECT val FROM DISCOUNTS WHERE target_id = p.prod_id AND SYSDATE BETWEEN start_date AND end_date AND is_active = 1) &lt; 10 
            </if>
            <if test="discountRate == 'under20'"> 
                AND (SELECT val FROM DISCOUNTS WHERE target_id = p.prod_id AND SYSDATE BETWEEN start_date AND end_date AND is_active = 1) &lt; 20 
            </if>
        </where>
    </sql>

    <!-- 상품 목록 조회 -->
    <select id="listProduct" parameterType="map" resultType="com.maknaez.model.ProductDTO">
        SELECT 
            p.prod_id       AS prodId,
            p.prod_name     AS prodName,
            p.base_price    AS price,
            p.thumb_nail    AS thumbnail,
            p.prod_desc     AS description,
            TO_CHAR(p.prod_date, 'YYYY-MM-DD') AS regDate,
            
            p.cate_code     AS cateCode,
            c.cate_name     AS cateName,
            c.cate_parent   AS cateParent,
            
            <!-- 할인율 조회: val 컬럼 사용, target_id 매핑 -->
            NVL((SELECT val 
                 FROM DISCOUNTS 
                 WHERE target_id = p.prod_id 
                 AND SYSDATE BETWEEN start_date AND end_date
                 AND is_active = 1), 0) AS discountRate,
                 
            p.base_price    AS originalPrice
            
        FROM PRODUCTS p
        LEFT JOIN CATEGORY c ON p.cate_code = c.cate_code
        
        <include refid="where-list"/>
        
        <choose>
            <when test="sort == 'price_asc'">ORDER BY p.base_price ASC</when>
            <when test="sort == 'price_desc'">ORDER BY p.base_price DESC</when>
            <otherwise>ORDER BY p.prod_date DESC</otherwise>
        </choose>
        
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>

    <!-- 개수 조회 -->
    <select id="dataCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM PRODUCTS p
        LEFT JOIN CATEGORY c ON p.cate_code = c.cate_code
        <include refid="where-list"/>
    </select>

</mapper>