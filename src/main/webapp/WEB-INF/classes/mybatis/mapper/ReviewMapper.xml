<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.maknaez.mapper.ReviewMapper">

	<!-- 1. 리뷰 전체 개수 조회 -->
	<select id="dataCount" parameterType="long" resultType="int">
		SELECT COUNT(*)
		FROM reviews r
		JOIN order_items oi ON r.item_id = oi.item_id
		JOIN pd_size sz ON oi.opt_id = sz.opt_id
		JOIN products ps ON sz.prod_id = ps.prod_id
		WHERE ps.prod_id = #{prodId}
	</select>

	<!-- 2. 리뷰 목록 조회 (페이징 적용 + 테이블 컬럼명 수정) -->
	<select id="selectReviewsByProdId" parameterType="map" resultType="com.maknaez.model.ReviewDTO">
		SELECT * FROM (
			SELECT ROWNUM rnum, tb.* FROM (
				SELECT 
					r.item_id AS reviewId,
					ps.prod_id AS prodId,
					m.memberidx AS memberIdx,
					r.content AS content,
					r.rating AS starRating,
					NVL(r.img_url, '') AS reviewImg,
					TO_CHAR(r.reg_date, 'YYYY-MM-DD') AS regDate,
					CASE WHEN MOD(r.item_id, 2) = 0 THEN '260mm' ELSE '270mm' END AS optionValue,
					CASE 
						WHEN m.nickname IS NULL THEN '익명'
						WHEN LENGTH(m.nickname) &lt;= 1 THEN '*'
						WHEN LENGTH(m.nickname) = 2 THEN SUBSTR(m.nickname, 1, 1) || '*' 
						ELSE SUBSTR(m.nickname, 1, 1) || LPAD('*', LENGTH(m.nickname) - 2, '*') || SUBSTR(m.nickname, -1, 1)
					END AS writerName,
					m.userid AS writerId
				FROM 
					reviews r
				JOIN 
					order_items oi ON r.item_id = oi.item_id
				JOIN 
					pd_size sz ON oi.opt_id = sz.opt_id
				JOIN 
					products ps ON sz.prod_id = ps.prod_id
				/* [수정됨] ORDERS 테이블의 PK는 ORDER_ID가 아니라 ITEMS_ID임 (DDL 기준) */
				JOIN 
					orders o ON oi.order_id = o.items_id
				JOIN 
					member1 m ON o.memberidx = m.memberidx
				WHERE 
					ps.prod_id = #{prodId}
				ORDER BY 
					r.reg_date DESC
			) tb WHERE ROWNUM &lt;= #{end}
		) WHERE rnum &gt;= #{start}
	</select>

</mapper>