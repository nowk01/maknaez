<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.maknaez.mapper.ReviewMapper">

    <select id="dataCount" parameterType="long" resultType="int">
		SELECT COUNT(*)
		FROM reviews r
		JOIN order_items oi ON r.item_id = oi.item_id
		JOIN pd_size sz ON oi.opt_id = sz.opt_id
		WHERE sz.prod_id = #{prodId}
	</select>
    
    <select id="dataCountAdmin" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM reviews r
        JOIN order_items oi ON r.item_id = oi.item_id
        JOIN pd_size sz ON oi.opt_id = sz.opt_id
        JOIN products p ON sz.prod_id = p.prod_id
        <where>
            <if test="keyword != null and keyword != ''">
                AND INSTR(p.prod_name, #{keyword}) &gt; 0
            </if>
            <if test="score != 0">
                AND r.rating = #{score}
            </if>
        </where>
    </select>

	<select id="selectReviewsByProdId" parameterType="map" resultType="com.maknaez.model.ReviewDTO">
		SELECT * FROM (
			SELECT ROWNUM rnum, tb.* FROM (
				SELECT
					r.item_id AS reviewId,
					sz.prod_id AS prodId,
					m.memberidx AS memberIdx,
					r.content AS content,
					r.rating AS starRating,
					NVL(r.img_url, '') AS reviewImg,
					TO_CHAR(r.reg_date, 'YYYY-MM-DD') AS regDate,
					sz.pd_size AS optionValue,
					CASE
						WHEN m.nickname IS NULL THEN '익명'
						WHEN LENGTH(m.nickname) &lt;= 1 THEN '*'
						WHEN LENGTH(m.nickname) = 2 THEN SUBSTR(m.nickname, 1, 1) || '*'
						ELSE SUBSTR(m.nickname, 1, 1) || LPAD('*', LENGTH(m.nickname) - 2, '*') || SUBSTR(m.nickname, -1, 1)
					END AS writerName,
					m.userid AS writerId
				FROM reviews r
				JOIN order_items oi ON r.item_id = oi.item_id
				JOIN pd_size sz ON oi.opt_id = sz.opt_id
				JOIN orders o ON oi.order_id = o.items_id
				JOIN member1 m ON o.memberidx = m.memberidx
				WHERE sz.prod_id = #{prodId}
				ORDER BY r.reg_date DESC
			) tb WHERE ROWNUM &lt;= #{end}
		) WHERE rnum &gt;= #{start}
	</select>

    <select id="listReviewAdmin" parameterType="map" resultType="com.maknaez.model.ReviewDTO">
        SELECT * FROM (
            SELECT ROWNUM rnum, tb.* FROM (
                SELECT
                    r.item_id AS reviewId,
                    p.prod_id AS prodId,
                    p.prod_name AS productName,
                    m.memberidx AS memberIdx,
                    m.userid AS writerId,
                    m.nickname AS writerName,
                    r.content AS content,
                    r.rating AS starRating,
                    NVL(r.img_url, '') AS reviewImg,
                    TO_CHAR(r.reg_date, 'YYYY-MM-DD HH24:MI') AS regDate,
                    sz.pd_size AS optionValue
                    FROM reviews r
                JOIN order_items oi ON r.item_id = oi.item_id
                JOIN pd_size sz ON oi.opt_id = sz.opt_id
                JOIN products p ON sz.prod_id = p.prod_id
                JOIN orders o ON oi.order_id = o.items_id
                JOIN member1 m ON o.memberidx = m.memberidx
                <where>
                    <if test="keyword != null and keyword != ''">
                        AND INSTR(p.prod_name, #{keyword}) &gt; 0
                    </if>
                    <if test="score != 0">
                        AND r.rating = #{score}
                    </if>
                </where>
                ORDER BY
                <choose>
                    <when test="sort == 'score'"> r.rating DESC, r.reg_date DESC </when>
                    <otherwise> r.reg_date DESC </otherwise>
                </choose>
            ) tb WHERE ROWNUM &lt;= #{end}
        ) WHERE rnum &gt;= #{start}
    </select>
    
    <select id="findById" parameterType="long" resultType="com.maknaez.model.ReviewDTO">
        SELECT
            r.item_id AS reviewId,
            p.prod_id AS prodId,
            p.prod_name AS productName,
            m.memberidx AS memberIdx,
            m.userid AS writerId,
            m.nickname AS writerName,
            r.content AS content,
            r.rating AS starRating,
            NVL(r.img_url, '') AS reviewImg,
            TO_CHAR(r.reg_date, 'YYYY-MM-DD HH24:MI:SS') AS regDate,
            sz.pd_size AS optionValue
        FROM reviews r
        JOIN order_items oi ON r.item_id = oi.item_id
        JOIN pd_size sz ON oi.opt_id = sz.opt_id
        JOIN products p ON sz.prod_id = p.prod_id
        JOIN orders o ON oi.order_id = o.items_id
        JOIN member1 m ON o.memberidx = m.memberidx
        WHERE r.item_id = #{reviewId}
    </select>

    <insert id="insertReview" parameterType="com.maknaez.model.ReviewDTO">
        INSERT INTO reviews (
            item_id, rating, content, img_url, reg_date
        ) VALUES (
            (SELECT item_id FROM order_items WHERE order_id = #{orderNum} AND ROWNUM = 1), 
            #{starRating}, #{content}, #{reviewImg, jdbcType=VARCHAR}, SYSDATE
        )
    </insert>
    
    <update id="updateReviewStatus" parameterType="map">
        SELECT 1 FROM DUAL -- 더미 쿼리 (컬럼 추가 후 위 주석 해제 및 이 라인 삭제)
    </update>

    <delete id="deleteReview" parameterType="long">
        DELETE FROM reviews WHERE item_id = #{reviewId}
    </delete>
    
    <select id="findByOrderNum" parameterType="String" resultType="Integer">
        SELECT COUNT(*)
        FROM reviews r
        JOIN order_items oi ON r.item_id = oi.item_id
        WHERE oi.order_id = #{orderNum}
    </select>

    <select id="countMyReviews" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM reviews r
        JOIN order_items oi ON r.item_id = oi.item_id
        JOIN orders o ON oi.order_id = o.items_id
        WHERE o.memberidx = #{memberIdx}
    </select>

    <select id="selectMyReviews" parameterType="map" resultType="com.maknaez.model.ReviewDTO">
        SELECT * FROM (
            SELECT ROWNUM rnum, tb.* FROM (
                SELECT
                    r.item_id AS reviewId,
                    ps.prod_id AS prodId,
                    o.items_id AS orderNum,
                    r.content AS content,
                    r.rating AS starRating,
                    NVL(r.img_url, '') AS reviewImg,
                    TO_CHAR(r.reg_date, 'YYYY-MM-DD') AS regDate,
                    ps.prod_name AS productName,
                    ps.thumb_nail AS thumbNail
                FROM reviews r
                JOIN order_items oi ON r.item_id = oi.item_id
                JOIN pd_size sz ON oi.opt_id = sz.opt_id
                JOIN products ps ON sz.prod_id = ps.prod_id
                JOIN orders o ON oi.order_id = o.items_id
                WHERE o.memberidx = #{memberIdx}
                ORDER BY r.reg_date DESC
            ) tb WHERE ROWNUM &lt;= #{end}
        ) WHERE rnum &gt;= #{start}
    </select>
    
    <select id="selectProductReviewStats" parameterType="long" resultType="map">
		SELECT 
			NVL(ROUND(AVG(r.rating), 1), 0) AS avgRating,
			COUNT(r.item_id) AS totalCount
		FROM reviews r
		JOIN order_items oi ON r.item_id = oi.item_id
		JOIN pd_size sz ON oi.opt_id = sz.opt_id
		WHERE sz.prod_id = #{prodId}
	</select>

</mapper>