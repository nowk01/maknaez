<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.maknaez.mapper.ReviewMapper">

	<!-- 리뷰 불러오기 -->
	 <select id="selectReviewsByProdId" parameterType="long" resultType="com.maknaez.model.ReviewDTO">
        SELECT 
            r.item_id AS reviewId,
            ps.prod_id AS prodId,
            o.memberidx AS memberIdx,
            r.content AS content,
            r.rating AS starRating,
            r.img_url AS reviewImg,
            TO_CHAR(r.reg_date, 'YYYY-MM-DD') AS regDate,
            
            -- 옵션 값 (PD_SIZE 테이블에 사이즈 정보가 있다면 가져오기, 없으면 예시 값)
            -- ps.p_size 또는 해당 컬럼명으로 교체 필요. 우선 예시 유지
            CASE WHEN MOD(r.item_id, 2) = 0 THEN '260mm' ELSE '270mm' END AS optionValue,
            
            -- 작성자 이름 (MEMBER1)
            NVL(m.nickname, '익명') AS writerName,
            
            -- ID 마스킹 (MEMBER1)
            RPAD(
                SUBSTR(m.userid, 1, 3), 
                CASE 
                    WHEN INSTR(m.userid, '@') > 0 THEN INSTR(m.userid, '@') - 1 
                    ELSE LENGTH(m.userid) 
                END, 
                '*'
            ) AS writerId
        FROM 
            reviews r
        JOIN 
            order_items oi ON r.item_id = oi.item_id
        JOIN
            pd_size ps ON oi.opt_id = ps.opt_id
        JOIN 
            orders o ON oi.order_id = o.items_id
        LEFT JOIN 
            member1 m ON o.memberidx = m.memberidx
        WHERE 
            ps.prod_id = #{prodId}
        ORDER BY 
            r.reg_date DESC
    </select>

</mapper>