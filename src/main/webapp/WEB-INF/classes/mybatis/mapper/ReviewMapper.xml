<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.maknaez.mapper.ReviewMapper">

    <!-- 데이터 개수 -->
	<select id="dataCount" parameterType="long" resultType="int">
		SELECT COUNT(*)
		FROM reviews r
		JOIN order_items oi ON r.item_id = oi.item_id
		JOIN pd_size sz ON oi.opt_id = sz.opt_id
		WHERE sz.prod_id = #{prodId}
	</select>

	<!-- 상품별 리뷰 목록 조회 -->
	<select id="selectReviewsByProdId" parameterType="map" resultType="com.maknaez.model.ReviewDTO">
		SELECT * FROM (
			SELECT ROWNUM rnum, tb.* FROM (
				SELECT
					r.item_id AS reviewId,
					sz.prod_id AS prodId,
					m.memberidx AS memberIdx,
					r.content AS content,
					r.rating AS starRating,
					NVL(r.img_url, '') AS reviewImg,
					TO_CHAR(r.reg_date, 'YYYY-MM-DD') AS regDate,
					/* 옵션 정보: PD_SIZE 테이블에서 직접 가져옴 */
					sz.pd_size AS optionValue,
					/* 작성자 이름 마스킹 */
					CASE
						WHEN m.nickname IS NULL THEN '익명'
						WHEN LENGTH(m.nickname) &lt;= 1 THEN '*'
						WHEN LENGTH(m.nickname) = 2 THEN SUBSTR(m.nickname, 1, 1) || '*'
						ELSE SUBSTR(m.nickname, 1, 1) || LPAD('*', LENGTH(m.nickname) - 2, '*') || SUBSTR(m.nickname, -1, 1)
					END AS writerName,
					m.userid AS writerId
				FROM reviews r
				JOIN order_items oi ON r.item_id = oi.item_id
				JOIN pd_size sz ON oi.opt_id = sz.opt_id        /* 상품 ID 확인을 위해 사이즈 테이블 조인 */
				JOIN orders o ON oi.order_id = o.items_id       /* ORDERS 테이블 PK는 ITEMS_ID */
				JOIN member1 m ON o.memberidx = m.memberidx
				WHERE sz.prod_id = #{prodId}
				ORDER BY r.reg_date DESC
			) tb WHERE ROWNUM &lt;= #{end}
		) WHERE rnum &gt;= #{start}
	</select>

    <insert id="insertReview" parameterType="com.maknaez.model.ReviewDTO">
        INSERT INTO reviews (
            item_id, rating, content, img_url, reg_date
        ) VALUES (
            -- REVIEWS 테이블 PK가 ITEM_ID(ORDER_ITEMS의 PK)이므로 이를 맞춰야 함
            (SELECT item_id FROM order_items WHERE order_id = #{orderNum} AND ROWNUM = 1), 
            #{starRating}, #{content}, #{reviewImg, jdbcType=VARCHAR}, SYSDATE
        )
    </insert>
    
    <select id="findByOrderNum" parameterType="String" resultType="Integer">
        SELECT COUNT(*)
        FROM reviews r
        JOIN order_items oi ON r.item_id = oi.item_id
        WHERE oi.order_id = #{orderNum}
    </select>

    <select id="countMyReviews" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM reviews r
        JOIN order_items oi ON r.item_id = oi.item_id
        JOIN orders o ON oi.order_id = o.items_id
        WHERE o.memberidx = #{memberIdx}
    </select>

    <select id="selectMyReviews" parameterType="map" resultType="com.maknaez.model.ReviewDTO">
        SELECT * FROM (
            SELECT ROWNUM rnum, tb.* FROM (
                SELECT
                    r.item_id AS reviewId,
                    ps.prod_id AS prodId,
                    o.items_id AS orderNum,
                    r.content AS content,
                    r.rating AS starRating,
                    NVL(r.img_url, '') AS reviewImg,
                    TO_CHAR(r.reg_date, 'YYYY-MM-DD') AS regDate,
                    ps.prod_name AS productName,
                    ps.thumb_nail AS thumbNail
                FROM reviews r
                JOIN order_items oi ON r.item_id = oi.item_id
                JOIN pd_size sz ON oi.opt_id = sz.opt_id
                JOIN products ps ON sz.prod_id = ps.prod_id
                JOIN orders o ON oi.order_id = o.items_id
                WHERE o.memberidx = #{memberIdx}
                ORDER BY r.reg_date DESC
            ) tb WHERE ROWNUM &lt;= #{end}
        ) WHERE rnum &gt;= #{start}
    </select>

</mapper>