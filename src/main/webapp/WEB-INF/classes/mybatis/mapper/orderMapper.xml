<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.maknaez.mapper.OrderMapper">

	<select id="getProduct" parameterType="long" resultType="com.maknaez.model.ProductDTO">
		SELECT
			PROD_ID       AS prodId,
			CATE_CODE     AS cateCode,
			PROD_NAME     AS prodName,
			PROD_DESC     AS description,
			BASE_PRICE    AS price,
			IS_DISPLAYED  AS isDisplayed,
			THUMB_NAIL    AS thumbnail,
			TO_CHAR(PROD_DATE, 'YYYY-MM-DD')    AS regDate,
			TO_CHAR(SHIPPED_DATE, 'YYYY-MM-DD') AS shippedDate,
			STATUS        AS status
		FROM PRODUCTS
		WHERE PROD_ID = #{prodId}
	</select>
	
	<select id="dataCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*), 0)
		FROM orders o
		LEFT JOIN member1 m1 ON
		o.MEMBERIDX = m1.MEMBERIDX
		LEFT JOIN member2 m2 ON o.MEMBERIDX =
		m2.MEMBERIDX
		<where>
			<if test="memberIdx != null and memberIdx != ''">
				AND o.MEMBERIDX = #{memberIdx}
			</if>
			<if test="historyStartDate != null and historyStartDate != ''">
				AND o.ORDER_DATE &gt;= TO_DATE(#{historyStartDate},
				'YYYY-MM-DD')
			</if>
			<if test="historyEndDate != null and historyEndDate != ''">
				AND o.ORDER_DATE &lt; TO_DATE(#{historyEndDate},
				'YYYY-MM-DD') + 1
			</if>
			<if test="startDate != null and startDate != ''">
				AND o.ORDER_DATE &gt;= TO_DATE(#{startDate},
				'YYYY-MM-DD')
			</if>
			<if test="endDate != null and endDate != ''">
				AND o.ORDER_DATE &lt; TO_DATE(#{endDate}, 'YYYY-MM-DD') +
				1
			</if>
			<if test="status != null and status != ''">
				AND o.STATUS = #{status}
			</if>

			<if test="orderState != null and orderState != ''">
				AND o.STATUS = #{orderState}
			</if>

			<if test="searchValue != null and searchValue != ''">
				AND (o.ITEMS_ID LIKE '%' || #{searchValue} || '%'
				OR
				m2.userName LIKE '%' || #{searchValue} || '%')
			</if>
			<if test="claimType != null and claimType != ''">
				AND o.STATUS LIKE '%' || #{claimType} || '%'
			</if>
			<if test="mode == 'claim' or mode == 'cancel'">
				AND o.STATUS IN ('취소신청', '취소처리중', '취소완료', '반품신청',
				'반품진행중', '반품완료',
				'환불완료', '교환신청', '교환완료')
			</if>
		</where>
	</select>

	<select id="listOrder" parameterType="map"
		resultType="com.maknaez.model.OrderDTO">
		SELECT * FROM (
		SELECT
		ROW_NUMBER() OVER(ORDER BY o.ORDER_DATE DESC) AS
		rnum,
		o.ITEMS_ID AS orderNum,
		TO_CHAR(o.ORDER_DATE, 'YYYY-MM-DD') AS
		orderDate,
		NVL(o.TOTAL_AMOUNT, 0) AS totalAmount,
		o.STATUS AS
		orderState,
		NVL(p.PROD_NAME, '상품정보없음') AS productName,
		NVL(p.PROD_ID, 0)
		AS productNum,
		NVL(p.THUMB_NAIL, 'no-image.png') AS thumbNail,

		NVL(oi.COUNT, 0) AS qty,
		NVL(oi.PRICE, 0) AS price,
		NVL(ps.PD_SIZE, '-')
		AS pdSize,

		NVL(m2.userName, '탈퇴회원') AS userName,
		NVL(m1.userId,'unknown') AS userId,
		m2.tel FROM orders o
		LEFT JOIN
		order_items oi ON
		o.ITEMS_ID = oi.ORDER_ID
		LEFT JOIN pd_size ps ON
		oi.OPT_ID = ps.OPT_ID
		LEFT JOIN products p ON ps.PROD_ID = p.PROD_ID
		LEFT JOIN member1 m1 ON
		o.MEMBERIDX = m1.MEMBERIDX
		LEFT JOIN member2 m2
		ON o.MEMBERIDX =
		m2.MEMBERIDX
		<where>
			<if test="memberIdx != null and memberIdx != ''">
				AND o.MEMBERIDX = #{memberIdx}
			</if>
			<if test="orderState != null and orderState != ''">
				AND o.STATUS = #{orderState}
			</if>
			<if test="historyStartDate != null and historyStartDate != ''">
				AND o.ORDER_DATE &gt;= TO_DATE(#{historyStartDate},
				'YYYY-MM-DD')
			</if>
			<if test="historyEndDate != null and historyEndDate != ''">
				AND o.ORDER_DATE &lt; TO_DATE(#{historyEndDate},
				'YYYY-MM-DD') + 1
			</if>
			<if test="startDate != null and startDate != ''">
				AND o.ORDER_DATE &gt;= TO_DATE(#{startDate},
				'YYYY-MM-DD')
			</if>
			<if test="endDate != null and endDate != ''">
				AND o.ORDER_DATE &lt; TO_DATE(#{endDate}, 'YYYY-MM-DD') +
				1
			</if>
			<if test="status != null and status != ''">
				AND o.STATUS = #{status}
			</if>

			<if test="searchValue != null and searchValue != ''">
				AND (o.ITEMS_ID LIKE '%' || #{searchValue} || '%'
				OR
				m2.userName LIKE '%' || #{searchValue} || '%')
			</if>

			<if test="claimType != null and claimType != ''">
				AND o.STATUS LIKE '%' || #{claimType} || '%'
			</if>

			<if test="mode == 'cancel'">
				AND o.STATUS IN ('취소신청', '취소처리중', '취소완료', '반품신청',
				'반품진행중', '반품완료',
				'환불완료', '교환신청', '교환완료')
			</if>

			<if test="mode == 'claim'">
				AND o.STATUS IN ('취소신청', '취소처리중', '취소완료', '반품신청',
				'반품진행중', '반품완료',
				'환불완료', '교환신청', '교환완료')
			</if>


		</where>
		) WHERE rnum BETWEEN #{start} AND #{end}
	</select>

	<update id="updateOrderState" parameterType="map">
		UPDATE orders
		SET
		STATUS = #{status}
		WHERE ITEMS_ID = #{orderNum}
	</update>

	<insert id="insertClaim" parameterType="map">
		INSERT INTO claims (
		claim_id, ITEMS_ID, type, reason, status, req_date
		) VALUES (
		claims_seq.NEXTVAL, #{orderId}, #{claimType}, #{reason},
		#{claimStatus}, SYSDATE
		)
	</insert>

	<select id="findByIdClaim" parameterType="String"
		resultType="map">
		SELECT
		c.CLAIM_ID, c.ITEMS_ID, c.TYPE, c.REASON, c.STATUS,
		TO_CHAR(c.REQ_DATE, 'YYYY-MM-DD') AS REQ_DATE
		FROM claims c
		WHERE
		c.ITEMS_ID = #{orderId}
	</select>

	<update id="updateClaimApprove" parameterType="map">
		UPDATE orders
		SET
		STATUS = #{status}
		WHERE ITEMS_ID = #{orderNum}
	</update>

	<update id="updateStockIncrease" parameterType="map">
		UPDATE pd_size
		SET STOCK = STOCK + #{qty}
		WHERE PROD_ID = #{productNum} AND PD_SIZE =
		#{pdSize}
	</update>

	<select id="returnCompleteCount" resultType="Integer">
		SELECT COUNT(*)
		FROM
		memberOrder
		WHERE memberIdx = #{memberIdx}
		AND orderState = '반품완료'
	</select>

	<select id="estimateCount" parameterType="map"
		resultType="Integer">
		SELECT NVL(COUNT(*), 0) FROM orders o
		LEFT JOIN member2 m2 ON
		o.MEMBERIDX = m2.MEMBERIDX
		<where>
			<if test="startDate != null and startDate != ''">
				AND o.ORDER_DATE &gt;= TO_DATE(#{startDate},
				'YYYY-MM-DD')
			</if>
			<if test="endDate != null and endDate != ''">
				AND o.ORDER_DATE &lt; TO_DATE(#{endDate}, 'YYYY-MM-DD') +
				1
			</if>
			<if test="searchValue != null and searchValue != ''">
				AND (o.ITEMS_ID LIKE '%' || #{searchValue} || '%'
				OR
				m2.userName LIKE '%' || #{searchValue} || '%')
			</if>
		</where>
	</select>

	<select id="listEstimate" parameterType="map" resultType="map">
		SELECT
		* FROM (
		SELECT rownum rnum, tb.* FROM (
		SELECT
		o.ITEMS_ID AS
		"orderNum",
		m2.userName AS "userName",
		m1.userId AS "userId",
		m2.tel AS
		"tel",
		(SELECT MIN(p2.PROD_NAME) || DECODE(COUNT(*), 1, '', ' 외 ' ||
		(COUNT(*) - 1)
		|| '건')
		FROM order_items oi2
		JOIN pd_size ps2 ON
		oi2.OPT_ID = ps2.OPT_ID
		JOIN products p2 ON ps2.PROD_ID = p2.PROD_ID
		WHERE oi2.ORDER_ID = o.ITEMS_ID) AS "content",
		(SELECT SUM(COUNT) FROM
		order_items WHERE ORDER_ID = o.ITEMS_ID) AS "qty",
		TO_CHAR(o.ORDER_DATE, 'YYYY.MM.DD') AS "regDate",
		o.STATUS AS "status"
		FROM orders o
		JOIN member1 m1 ON o.MEMBERIDX = m1.MEMBERIDX
		JOIN member2
		m2 ON o.MEMBERIDX = m2.MEMBERIDX
		<where>
			<if test="startDate != null and startDate != ''">
				AND o.ORDER_DATE &gt;= TO_DATE(#{startDate},
				'YYYY-MM-DD')
			</if>
			<if test="endDate != null and endDate != ''">
				AND o.ORDER_DATE &lt; TO_DATE(#{endDate}, 'YYYY-MM-DD') +
				1
			</if>
			<if test="searchValue != null and searchValue != ''">
				AND (o.ITEMS_ID LIKE '%' || #{searchValue} || '%'
				OR
				m2.userName LIKE '%' || #{searchValue} || '%')
			</if>
		</where>
		ORDER BY o.ORDER_DATE DESC
		) tb WHERE
		rownum &lt;= #{end}
		) WHERE rnum
		&gt;= #{start}

	</select>

	<select id="waitingEstimateCount" resultType="Integer">
		SELECT
		NVL(COUNT(*), 0) FROM orders WHERE STATUS = '결제완료'
	</select>

	<select id="getOrderDetailsForEstimate" parameterType="String"
		resultType="map">
		SELECT
		o.ITEMS_ID AS "orderNum",
		p.THUMB_NAIL AS "thumbNail",
		p.PROD_NAME AS "productName",
		ps.PD_SIZE AS "pdSize",
		oi.COUNT AS "qty",
		oi.PRICE AS "price",
		o.TOTAL_AMOUNT AS "totalAmount",
		m2.userName AS
		"userName",
		m1.userId AS "userId",
		m2.tel AS "tel",
		m2.email AS "email",
		TO_CHAR(o.ORDER_DATE, 'YYYY-MM-DD') AS "orderDate"
		FROM orders o
		JOIN
		order_items oi ON o.ITEMS_ID = oi.ORDER_ID
		JOIN pd_size ps ON oi.OPT_ID
		= ps.OPT_ID
		JOIN products p ON ps.PROD_ID = p.PROD_ID
		JOIN member1 m1 ON
		o.MEMBERIDX = m1.MEMBERIDX
		JOIN member2 m2 ON o.MEMBERIDX =
		m2.MEMBERIDX
		WHERE o.ITEMS_ID = #{orderNum}
	</select>
	
	<!-- 장바구니 기반 주문 목록 조회 -->
	<select id="selectOrderListByCart" parameterType="list" resultType="map">
		SELECT 
			p.prod_id    AS "PROD_ID",
			p.prod_name  AS "PROD_NAME",
			p.thumb_nail AS "THUMBNAIL",
			p.base_price AS "PRICE",
			c.quantity   AS "QUANTITY",
			(p.base_price * c.quantity) AS "TOTAL_PRICE",
			NVL(s.pd_size, '기본옵션') AS "OPTION_VALUE",
			c.opt_id     AS "OPT_ID"
		FROM cart c
		JOIN products p ON c.prod_id = p.prod_id
		LEFT JOIN pd_size s ON c.opt_id = s.opt_id
		WHERE c.cart_id IN 
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>

	<!-- 단일 상품 바로 구매 정보 조회 -->
	<select id="selectProductForOrder" parameterType="map" resultType="map">
		SELECT 
			p.prod_id    AS "PROD_ID",
			p.prod_name  AS "PROD_NAME",
			p.thumb_nail AS "THUMBNAIL",
			p.base_price AS "PRICE",
			#{quantity}  AS "QUANTITY",
			(p.base_price * #{quantity}) AS "TOTAL_PRICE",
			NVL(s.pd_size, '기본옵션') AS "OPTION_VALUE",
			NVL(s.opt_id, 0) AS "OPT_ID"
		FROM products p
		LEFT JOIN pd_size s ON p.prod_id = s.prod_id AND s.opt_id = #{optId}
		WHERE p.prod_id = #{prodId}
	</select>
	
	<!-- 주문창 배송지 조회  -->
	<select id="listAddress" parameterType="Long" resultType="com.maknaez.model.AddressDTO">
        SELECT
            addr_id AS addrId,
            memberIdx,
            NVL(addr_name, '배송지') AS addrName,
            receiver_name AS receiverName,
            receiver_tel AS receiverTel,
            zip_code AS zipCode,
            addr1,
            addr2,
            isbasic AS isBasic
        FROM address
        WHERE memberIdx = #{memberIdx}
        ORDER BY isbasic DESC, addr_id DESC
    </select>
    
   <!-- 주문 마스터 저장 -->
	<insert id="insertOrder" parameterType="com.maknaez.model.OrderDTO">
		INSERT INTO orders (
			ITEMS_ID, 
			MEMBERIDX, 
			ORDER_DATE, 
			TOTAL_AMOUNT, 
			REAL_TOTAL_AMOUNT, 
			STATUS, 
			DELIVERY_NUMBER
		) VALUES (
			#{orderNum}, 
			#{memberIdx}, 
			SYSDATE, 
			#{totalAmount}, 
			#{totalAmount}, 
			#{orderState}, 
			#{deliveryNumber}
		)
	</insert>

	<!-- 장바구니 기반 주문 목록 조회 -->
	<select id="getOrderListByCart" parameterType="map" resultType="map">
		SELECT 
			c.cart_id    AS "CART_ID",
			p.prod_id    AS "PROD_ID",
			p.prod_name  AS "PROD_NAME",
			p.thumb_nail AS "THUMBNAIL",
			p.base_price AS "PRICE",
			c.quantity   AS "QUANTITY",
			(p.base_price * c.quantity) AS "TOTAL_PRICE",
			NVL(s.pd_size, '기본옵션') AS "PD_SIZE",
			c.opt_id     AS "OPT_ID"
		FROM cart c
		JOIN products p ON c.prod_id = p.prod_id
		LEFT JOIN pd_size s ON c.opt_id = s.opt_id
		WHERE c.cart_id IN 
		<foreach item="item" index="index" collection="cartIds" open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>

	<!-- 단일 상품 바로 구매 정보 조회 -->
	<select id="getProductDetailForOrder" parameterType="map" resultType="map">
		SELECT 
			p.prod_id    AS "PROD_ID",
			p.prod_name  AS "PROD_NAME",
			p.thumb_nail AS "THUMBNAIL",
			p.base_price AS "PRICE",
			#{quantity}  AS "QUANTITY",
			(p.base_price * #{quantity}) AS "TOTAL_PRICE",
			NVL(s.pd_size, '기본옵션') AS "PD_SIZE",
			NVL(s.opt_id, 0) AS "OPT_ID"
		FROM products p
		LEFT JOIN pd_size s ON p.prod_id = s.prod_id AND s.opt_id = #{optId}
		WHERE p.prod_id = #{prodId}
	</select>

    
    <!-- 배송 정보 저장 (SHIPMENTS 테이블) -->
    <insert id="insertShipment" parameterType="map">
        INSERT INTO shipments (
            delivery_number, 
            addr_id, 
            receiver_name, 
            receiver_tel, 
            zip_code, 
            addr1, 
            addr2, 
            memo, 
            status, 
            delivery_company
        ) VALUES (
            #{deliveryNumber}, 
            #{addrId, jdbcType=NUMERIC}, 
            #{receiverName}, 
            #{receiverTel}, 
            #{zipCode}, 
            #{addr1}, 
            #{addr2}, 
            #{memo, jdbcType=VARCHAR}, 
            #{status}, 
            #{company}
        )
    </insert>

    <!-- 주문 상세 저장 (ORDER_ITEMS 테이블) -->
	<insert id="insertOrderItem" parameterType="com.maknaez.model.OrderItemDTO">
		INSERT INTO order_items (
			ITEM_ID, 
			ORDER_ID, 
			OPT_ID, 
			COUNT, 
			PRICE
		) VALUES (
			ITEM_SEQ.NEXTVAL, 
			#{order_id}, 
			#{opt_id}, 
			#{count}, 
			#{price}
		)
	</insert>
	
	<!-- 결제 정보 저장 -->
	<insert id="insertPayment" parameterType="com.maknaez.model.PaymentDTO">
		INSERT INTO payments (
			PAY_ID, 
			ORDER_ID, 
			PAY_METHOD, 
			PAY_AMOUNT, 
			PG_TID, 
			PAY_STATUS, 
			CARD_NAME, 
			CARD_NUM
		) VALUES (
			PAY_SEQ.NEXTVAL, 
			#{orderId}, 
			#{payMethod}, 
			#{payAmount}, 
			#{pgTid}, 
			#{payStatus}, 
			#{cardName}, 
			#{cardNum}
		)
	</insert>
	
	<!-- 완료 페이지용 - 주문/배송 정보 조회 -->
	<select id="selectOrderCompleteInfo" parameterType="String" resultType="com.maknaez.model.OrderDTO">
		SELECT 
			o.items_id AS orderNum,
			o.memberIdx,
			TO_CHAR(o.order_date, 'YYYY-MM-DD HH24:MI') AS orderDate,
			o.total_amount AS totalAmount,
			o.status AS orderState,
			
			s.delivery_number AS deliveryNumber,
			s.receiver_name AS receiverName,
			s.receiver_tel AS receiverTel,
			s.zip_code AS zip,
			s.addr1,
			s.addr2,
			s.memo
		FROM orders o
		LEFT JOIN shipments s ON o.delivery_number = s.delivery_number
		WHERE o.items_id = #{orderId}
	</select>
	
	<!-- 완료 페이지용 - 결제 정보 조회 -->
	<select id="selectPaymentByOrder" parameterType="String" resultType="com.maknaez.model.PaymentDTO">
		SELECT
			pay_id AS payId,
			order_id AS orderId,
			pay_method AS payMethod,
			pay_amount AS payAmount,
			pg_tid AS pgTid,
			pay_status AS payStatus,
			card_name AS cardName,
			card_num AS cardNum
		FROM payments
		WHERE order_id = #{orderId}
	</select>
	
</mapper>