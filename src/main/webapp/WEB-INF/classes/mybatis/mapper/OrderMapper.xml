<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.maknaez.mapper.OrderMapper">

	<select id="dataCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*), 0)
		FROM orders
		<where>
			<if test="memberIdx != null and memberIdx != ''">
				AND MEMBERIDX = #{memberIdx}
			</if>
			<if test="orderState != null and orderState != ''">
				AND STATUS = #{orderState}
			</if>
			<if test="mode == 'cancel'">
				AND STATUS IN ('취소처리중', '취소완료', '반품진행중', '환불완료')
			</if>
			<if test="mode == 'claim'">
				AND STATUS IN ('취소신청', '반품신청', '취소완료', '반품완료')
			</if>
		</where>
	</select>

	<select id="listOrder" parameterType="map" resultType="com.maknaez.model.OrderDTO">
		SELECT * FROM (
			SELECT
				ROW_NUMBER() OVER(ORDER BY o.ORDER_DATE DESC) AS rnum,
				o.ITEMS_ID AS orderNum,
				TO_CHAR(o.ORDER_DATE, 'YYYY-MM-DD') AS orderDate,
				NVL(o.TOTAL_AMOUNT, 0) AS totalAmount,
				o.STATUS AS orderState,
				NVL(p.PROD_NAME, '상품정보없음') AS productName,
				NVL(p.PROD_ID, 0) AS productNum,
				NVL(oi.COUNT, 0) AS qty,
				NVL(oi.PRICE, 0) AS price,
				p.THUMB_NAIL AS thumbNail,
				ps.PD_SIZE AS pdSize,
				NVL(m2.userName, '탈퇴회원') AS userName,  NVL(m1.userId, 'unknown') AS userId       FROM orders o
			LEFT JOIN order_items oi ON o.ITEMS_ID = oi.ORDER_ID
			LEFT JOIN pd_size ps ON oi.OPT_ID = ps.OPT_ID
			LEFT JOIN products p ON ps.PROD_ID = p.PROD_ID
			LEFT JOIN member1 m1 ON o.MEMBERIDX = m1.MEMBERIDX
			LEFT JOIN member2 m2 ON o.MEMBERIDX = m2.MEMBERIDX
			<where>
				<if test="memberIdx != null and memberIdx != ''">
					AND o.MEMBERIDX = #{memberIdx}
				</if>
				<if test="orderState != null and orderState != ''">
					AND o.STATUS = #{orderState}
				</if>
				<if test="mode == 'cancel'">
					AND o.STATUS IN ('취소처리중', '취소완료', '반품진행중', '환불완료')
				</if>
				<if test="mode == 'claim'">
					AND o.STATUS IN ('취소신청', '반품신청', '취소완료', '반품완료')
				</if>
				<if test="historyStartDate != null and historyStartDate != ''">
					AND o.ORDER_DATE &gt;= TO_DATE(#{historyStartDate}, 'YYYY-MM-DD')
				</if>
				<if test="historyEndDate != null and historyEndDate != ''">
					AND o.ORDER_DATE &lt; TO_DATE(#{historyEndDate}, 'YYYY-MM-DD') + 1
				</if>
			</where>
		) WHERE rnum BETWEEN #{start} AND #{end}
	</select>

	<update id="updateOrderState" parameterType="map">
		UPDATE orders
		SET STATUS = #{status}
		WHERE ITEMS_ID = #{orderNum}
	</update>

	<insert id="insertClaim" parameterType="map">
		INSERT INTO claims (
			claim_id, ITEMS_ID, type, reason, status, req_date
		) VALUES (
			claims_seq.NEXTVAL, #{orderId}, #{claimType}, #{reason}, #{claimStatus}, SYSDATE
		)
	</insert>

	<select id="findByIdClaim" parameterType="String" resultType="map">
		SELECT
			c.CLAIM_ID, c.ITEMS_ID, c.TYPE, c.REASON, c.STATUS,
			TO_CHAR(c.REQ_DATE, 'YYYY-MM-DD') AS REQ_DATE
		FROM claims c
		WHERE c.ITEMS_ID = #{orderId}
	</select>

	<update id="updateClaimApprove" parameterType="map">
		UPDATE orders
		SET STATUS = #{status}
		WHERE ITEMS_ID = #{orderNum}
	</update>

	<update id="updateStockIncrease" parameterType="map">
		UPDATE pd_size
		SET STOCK = STOCK + #{qty}
		WHERE PROD_ID = #{productNum} AND PD_SIZE = #{pdSize}
	</update>

</mapper>